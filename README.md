# DeFinery

**DeFinery** is a tool for automated repair of smart contracts that do not satisfy their functional specification. Based on a user-defined correctness property and a trace leading to its violation, DeFinery automatically generates a diverse set of patches for a smart contract, while providing formal
correctness guarantees w.r.t. the intended behavior. It combines search-based patch generation with semantic analysis of an original program to efficiently navigate the search space and generate higher-quality patches that cannot be obtained by other smart contract repair tools.

A companion website with more detailed documentation can be found at: https://sites.google.com/view/ase2022-definery/.

## Experimental Data

We evaluated our tool on a dataset of 9 smart contracts that include 5 real-world DeFi smart contracts and 4 benchmark smart contracts selected from the [SmartBugs](https://github.com/smartbugs/smartbugs) dataset. The analyzed smart contracts are available in the [/contracts](https://github.com/definery-sc/DeFinery/tree/main/contracts) folder. The [/raw](https://github.com/definery-sc/DeFinery/tree/main/contracts/eval) folder contains adapted source code of the analyzed smart contracts, while [/eval](https://github.com/definery-sc/DeFinery/tree/main/contracts/eval) contains files that were symbolically analyzed, i.e., they include analyzed smart contract code, the Main contract encoding the harness function for symbolic analysis, and supplementary code (e.g., User smart contracts).

[/raw_results](https://github.com/definery-sc/DeFinery/tree/main/raw_results) reports raw experimental data for running our tool on our experimental dataset. On average, it tool **DeFinery** 53 seconds to analyze and fix a smart contract. We provide more detailed statistics on our [website](https://sites.google.com/view/ase2022-definery/).

## Quick Start

**DeFinery** can be run in a Docker container using the following command:

`docker run -it --rm -v  YOUR_PATH/experiments:/experiments/ definerysc/definery CONTRACT_NAME`

The command will pull the Docker container and execute both symbolic analysis and patch generation for a given smart contract, which can be one of the following: [xForce, iToken, cToken, Value, Uranium, Unprotected, Refund_NoSub, Confused_Sign, EtherBank]. Please make sure that `YOUR_PATH` is an absolute path.

Running this command will add files produced by symbolic engine and patch generator into the `YOUR_PATH/experiments/CONTRACT_NAME` folder. The `patched` folder contains plausible patches that pass the test cases generated by our tool. Once at least one of the patches passes conditional equivalence checking, you will see the following text pointing to the location of a correct patch in a <code>/patched</code> folder:

`The valid implementation is EQUIVALENT: /experiments/CONTRACT_NAME/patched/patched_0.sol`
